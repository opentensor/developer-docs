
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bittensor.core.axon &#8212; Bittensor SDK Docs  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bittensor-custom.css?v=c1dfe055" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/bittensor/core/axon';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo.svg" class="logo__image only-light" alt="Bittensor SDK Docs  documentation - Home"/>
    <img src="../../../_static/logo-dark-mode.svg" class="logo__image only-dark pst-js-only" alt="Bittensor SDK Docs  documentation - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../autoapi/bittensor/index.html">bittensor</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/bittensor/core/index.html">bittensor.core</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/async_subtensor/index.html">bittensor.core.async_subtensor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/axon/index.html">bittensor.core.axon</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/chain_data/index.html">bittensor.core.chain_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/config/index.html">bittensor.core.config</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/dendrite/index.html">bittensor.core.dendrite</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/errors/index.html">bittensor.core.errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/extrinsics/index.html">bittensor.core.extrinsics</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/metagraph/index.html">bittensor.core.metagraph</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/settings/index.html">bittensor.core.settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/stream/index.html">bittensor.core.stream</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/subtensor/index.html">bittensor.core.subtensor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/synapse/index.html">bittensor.core.synapse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/tensor/index.html">bittensor.core.tensor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/threadpool/index.html">bittensor.core.threadpool</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/core/types/index.html">bittensor.core.types</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/bittensor/utils/index.html">bittensor.utils</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/axon_utils/index.html">bittensor.utils.axon_utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/balance/index.html">bittensor.utils.balance</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/btlogging/index.html">bittensor.utils.btlogging</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/delegates_details/index.html">bittensor.utils.delegates_details</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/deprecated/index.html">bittensor.utils.deprecated</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/formatting/index.html">bittensor.utils.formatting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/mock/index.html">bittensor.utils.mock</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/networking/index.html">bittensor.utils.networking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/registration/index.html">bittensor.utils.registration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/subnets/index.html">bittensor.utils.subnets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/substrate_utils/index.html">bittensor.utils.substrate_utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/version/index.html">bittensor.utils.version</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/bittensor/utils/weight_utils/index.html">bittensor.utils.weight_utils</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/opentensor/btcli" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/opentensor/btcli/issues/new?title=Issue%20on%20page%20%2F_modules/bittensor/core/axon.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for bittensor.core.axon</h1><div class="highlight"><pre>
<span></span><span class="c1"># The MIT License (MIT)</span>
<span class="c1"># Copyright © 2024 Opentensor Foundation</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated</span>
<span class="c1"># documentation files (the “Software”), to deal in the Software without restriction, including without limitation</span>
<span class="c1"># the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="c1"># and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in all copies or substantial portions of</span>
<span class="c1"># the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO</span>
<span class="c1"># THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL</span>
<span class="c1"># THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION</span>
<span class="c1"># OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="c1"># DEALINGS IN THE SOFTWARE.</span>
<span class="sd">&quot;&quot;&quot;Create and initialize Axon, which services the forward and backward requests from other neurons.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span><span class="p">,</span> <span class="n">Signature</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">uvicorn</span>
<span class="kn">from</span> <span class="nn">bittensor_wallet</span> <span class="kn">import</span> <span class="n">Wallet</span><span class="p">,</span> <span class="n">Keypair</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span> <span class="nn">fastapi.routing</span> <span class="kn">import</span> <span class="n">serialize_response</span>
<span class="kn">from</span> <span class="nn">starlette.middleware.base</span> <span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span><span class="p">,</span> <span class="n">RequestResponseEndpoint</span>
<span class="kn">from</span> <span class="nn">starlette.requests</span> <span class="kn">import</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">starlette.responses</span> <span class="kn">import</span> <span class="n">Response</span>


<span class="kn">from</span> <span class="nn">bittensor.core.chain_data</span> <span class="kn">import</span> <span class="n">AxonInfo</span>
<span class="kn">from</span> <span class="nn">bittensor.core.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">bittensor.core.errors</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlacklistedException</span><span class="p">,</span>
    <span class="n">InvalidRequestNameError</span><span class="p">,</span>
    <span class="n">NotVerifiedException</span><span class="p">,</span>
    <span class="n">PostProcessException</span><span class="p">,</span>
    <span class="n">PriorityException</span><span class="p">,</span>
    <span class="n">SynapseDendriteNoneException</span><span class="p">,</span>
    <span class="n">SynapseException</span><span class="p">,</span>
    <span class="n">SynapseParsingError</span><span class="p">,</span>
    <span class="n">UnknownSynapseError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bittensor.core.settings</span> <span class="kn">import</span> <span class="n">DEFAULTS</span><span class="p">,</span> <span class="n">version_as_int</span>
<span class="kn">from</span> <span class="nn">bittensor.core.stream</span> <span class="kn">import</span> <span class="n">StreamingSynapse</span>
<span class="kn">from</span> <span class="nn">bittensor.core.synapse</span> <span class="kn">import</span> <span class="n">Synapse</span><span class="p">,</span> <span class="n">TerminalInfo</span>
<span class="kn">from</span> <span class="nn">bittensor.core.threadpool</span> <span class="kn">import</span> <span class="n">PriorityThreadPoolExecutor</span>
<span class="kn">from</span> <span class="nn">bittensor.utils</span> <span class="kn">import</span> <span class="n">networking</span><span class="p">,</span> <span class="n">Certificate</span>
<span class="kn">from</span> <span class="nn">bittensor.utils.axon_utils</span> <span class="kn">import</span> <span class="n">allowed_nonce_window_ns</span><span class="p">,</span> <span class="n">calculate_diff_seconds</span>
<span class="kn">from</span> <span class="nn">bittensor.utils.btlogging</span> <span class="kn">import</span> <span class="n">logging</span>

<span class="c1"># Just for annotation checker</span>
<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">bittensor.core.subtensor</span> <span class="kn">import</span> <span class="n">Subtensor</span>

<span class="c1"># Latest version with old style nonce structure (this in not a current SDK version)</span>
<span class="n">V_7_2_0</span> <span class="o">=</span> <span class="mi">7002000</span>


<div class="viewcode-block" id="FastAPIThreadedServer">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.FastAPIThreadedServer">[docs]</a>
<span class="k">class</span> <span class="nc">FastAPIThreadedServer</span><span class="p">(</span><span class="n">uvicorn</span><span class="o">.</span><span class="n">Server</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ``FastAPIThreadedServer`` class is a specialized server implementation for the Axon server in the Bittensor network.</span>

<span class="sd">    It extends the functionality of :func:`uvicorn.Server` to run the FastAPI application in a separate thread, allowing the Axon server to handle HTTP requests concurrently and non-blocking.</span>

<span class="sd">    This class is designed to facilitate the integration of FastAPI with the Axon&#39;s asynchronous architecture, ensuring efficient and scalable handling of network requests.</span>

<span class="sd">    Importance and Functionality</span>
<span class="sd">        Threaded Execution</span>
<span class="sd">            The class allows the FastAPI application to run in a separate thread, enabling concurrent handling of HTTP requests which is crucial for the performance and scalability of the Axon server.</span>

<span class="sd">        Seamless Integration</span>
<span class="sd">            By running FastAPI in a threaded manner, this class ensures seamless integration of FastAPI&#39;s capabilities with the Axon server&#39;s asynchronous and multi-threaded architecture.</span>

<span class="sd">        Controlled Server Management</span>
<span class="sd">            The methods start and stop provide controlled management of the server&#39;s lifecycle, ensuring that the server can be started and stopped as needed, which is vital for maintaining the Axon server&#39;s reliability and availability.</span>

<span class="sd">        Signal Handling</span>
<span class="sd">            Overriding the default signal handlers prevents potential conflicts with the Axon server&#39;s main application flow, ensuring stable operation in various network conditions.</span>

<span class="sd">    Use Cases</span>
<span class="sd">        Starting the Server</span>
<span class="sd">            When the Axon server is initialized, it can use this class to start the FastAPI application in a separate thread, enabling it to begin handling HTTP requests immediately.</span>

<span class="sd">        Stopping the Server</span>
<span class="sd">            During shutdown or maintenance of the Axon server, this class can be used to stop the FastAPI application gracefully, ensuring that all resources are properly released.</span>

<span class="sd">    Example Usage::</span>

<span class="sd">        self.app = FastAPI()</span>
<span class="sd">        log_level = &quot;trace&quot;</span>
<span class="sd">        self.fast_config = uvicorn.Config(self.app, host=&quot;0.0.0.0&quot;, port=self.config.axon.port, log_level=log_level)</span>
<span class="sd">        self.fast_server = FastAPIThreadedServer(config=self.fast_config)</span>
<span class="sd">        self.fast_server.start()</span>
<span class="sd">        # do something</span>
<span class="sd">        self.fast_server.stop()</span>

<span class="sd">    Args:</span>
<span class="sd">        should_exit (bool): Flag to indicate whether the server should stop running.</span>
<span class="sd">        is_running (bool): Flag to indicate whether the server is currently running.</span>

<span class="sd">    The server overrides the default signal handlers to prevent interference with the main application flow and provides methods to start and stop the server in a controlled manner.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">should_exit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_running</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="FastAPIThreadedServer.install_signal_handlers">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.FastAPIThreadedServer.install_signal_handlers">[docs]</a>
    <span class="k">def</span> <span class="nf">install_signal_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides the default signal handlers provided by ``uvicorn.Server``. This method is essential to ensure that the signal handling in the threaded server does not interfere with the main application&#39;s flow, especially in a complex asynchronous environment like the Axon server.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="FastAPIThreadedServer.run_in_thread">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.FastAPIThreadedServer.run_in_thread">[docs]</a>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">run_in_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manages the execution of the server in a separate thread, allowing the FastAPI application to run asynchronously without blocking the main thread of the Axon server. This method is a key component in enabling concurrent request handling in the Axon server.</span>

<span class="sd">        Yields:</span>
<span class="sd">            None: This method yields control back to the caller while the server is running in the background thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">should_exit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_wrapper_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A wrapper method for the :func:`run_in_thread` context manager. This method is used internally by the ``start`` method to initiate the server&#39;s execution in a separate thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_in_thread</span><span class="p">():</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_exit</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span>

<div class="viewcode-block" id="FastAPIThreadedServer.start">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.FastAPIThreadedServer.start">[docs]</a>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the FastAPI server in a separate thread if it is not already running. This method sets up the server to handle HTTP requests concurrently, enabling the Axon server to efficiently manage incoming network requests.</span>

<span class="sd">        The method ensures that the server starts running in a non-blocking manner, allowing the Axon server to continue its other operations seamlessly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">should_exit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrapper_run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FastAPIThreadedServer.stop">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.FastAPIThreadedServer.stop">[docs]</a>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signals the FastAPI server to stop running. This method sets the :func:`should_exit` flag to ``True``, indicating that the server should cease its operations and exit the running thread.</span>

<span class="sd">        Stopping the server is essential for controlled shutdowns and resource management in the Axon server, especially during maintenance or when redeploying with updated configurations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">should_exit</span> <span class="o">=</span> <span class="kc">True</span></div>
</div>



<div class="viewcode-block" id="Axon">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon">[docs]</a>
<span class="k">class</span> <span class="nc">Axon</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ``Axon`` class in Bittensor is a fundamental component that serves as the server-side interface for a neuron within the Bittensor network.</span>

<span class="sd">    This class is responsible for managing</span>
<span class="sd">    incoming requests from other neurons and implements various mechanisms to ensure efficient</span>
<span class="sd">    and secure network interactions.</span>

<span class="sd">    An axon relies on a FastAPI router to create endpoints for different message types. These</span>
<span class="sd">    endpoints are crucial for handling various request types that a neuron might receive. The</span>
<span class="sd">    class is designed to be flexible and customizable, allowing users to specify custom rules</span>
<span class="sd">    for forwarding, blacklisting, prioritizing, and verifying incoming requests. The class also</span>
<span class="sd">    includes internal mechanisms to manage a thread pool, supporting concurrent handling of</span>
<span class="sd">    requests with defined priority levels.</span>

<span class="sd">    Methods in this class are equipped to deal with incoming requests from various scenarios in the</span>
<span class="sd">    network and serve as the server face for a neuron. It accepts multiple arguments, like wallet,</span>
<span class="sd">    configuration parameters, ip address, server binding  port, external ip, external port and max</span>
<span class="sd">    workers. Key methods involve managing and operating the FastAPI application router, including</span>
<span class="sd">    the attachment and operation of endpoints.</span>

<span class="sd">    Key Features:</span>

<span class="sd">    - FastAPI router integration for endpoint creation and management.</span>
<span class="sd">    - Customizable request handling including forwarding, blacklisting, and prioritization.</span>
<span class="sd">    - Verification of incoming requests against custom-defined functions.</span>
<span class="sd">    - Thread pool management for concurrent request handling.</span>
<span class="sd">    - Command-line argument support for user-friendly program interaction.</span>

<span class="sd">    Example Usage::</span>

<span class="sd">        import bittensor</span>
<span class="sd">        # Define your custom synapse class</span>
<span class="sd">        class MySynapse( bittensor.Synapse ):</span>
<span class="sd">            input: int = 1</span>
<span class="sd">            output: int = None</span>

<span class="sd">        # Define a custom request forwarding function using your synapse class</span>
<span class="sd">        def forward( synapse: MySynapse ) -&gt; MySynapse:</span>
<span class="sd">            # Apply custom logic to synapse and return it</span>
<span class="sd">            synapse.output = 2</span>
<span class="sd">            return synapse</span>

<span class="sd">        # Define a custom request verification function</span>
<span class="sd">        def verify_my_synapse( synapse: MySynapse ):</span>
<span class="sd">            # Apply custom verification logic to synapse</span>
<span class="sd">            # Optionally raise Exception</span>
<span class="sd">            assert synapse.input == 1</span>
<span class="sd">            ...</span>

<span class="sd">        # Define a custom request blacklist function</span>
<span class="sd">        def blacklist_my_synapse( synapse: MySynapse ) -&gt; bool:</span>
<span class="sd">            # Apply custom blacklist</span>
<span class="sd">            return False ( if non blacklisted ) or True ( if blacklisted )</span>

<span class="sd">        # Define a custom request priority function</span>
<span class="sd">        def prioritize_my_synapse( synapse: MySynapse ) -&gt; float:</span>
<span class="sd">            # Apply custom priority</span>
<span class="sd">            return 1.0</span>

<span class="sd">        # Initialize Axon object with a custom configuration</span>
<span class="sd">        my_axon = bittensor.Axon(</span>
<span class="sd">            config=my_config,</span>
<span class="sd">            wallet=my_wallet,</span>
<span class="sd">            port=9090,</span>
<span class="sd">            ip=&quot;192.0.2.0&quot;,</span>
<span class="sd">            external_ip=&quot;203.0.113.0&quot;,</span>
<span class="sd">            external_port=7070</span>
<span class="sd">        )</span>

<span class="sd">        # Attach the endpoint with the specified verification and forward functions.</span>
<span class="sd">        my_axon.attach(</span>
<span class="sd">            forward_fn = forward_my_synapse,</span>
<span class="sd">            verify_fn = verify_my_synapse,</span>
<span class="sd">            blacklist_fn = blacklist_my_synapse,</span>
<span class="sd">            priority_fn = prioritize_my_synapse</span>
<span class="sd">        )</span>

<span class="sd">        # Serve and start your axon.</span>
<span class="sd">        my_axon.serve(</span>
<span class="sd">            netuid = ...</span>
<span class="sd">            subtensor = ...</span>
<span class="sd">        ).start()</span>

<span class="sd">        # If you have multiple forwarding functions, you can chain attach them.</span>
<span class="sd">        my_axon.attach(</span>
<span class="sd">            forward_fn = forward_my_synapse,</span>
<span class="sd">            verify_fn = verify_my_synapse,</span>
<span class="sd">            blacklist_fn = blacklist_my_synapse,</span>
<span class="sd">            priority_fn = prioritize_my_synapse</span>
<span class="sd">        ).attach(</span>
<span class="sd">            forward_fn = forward_my_synapse_2,</span>
<span class="sd">            verify_fn = verify_my_synapse_2,</span>
<span class="sd">            blacklist_fn = blacklist_my_synapse_2,</span>
<span class="sd">            priority_fn = prioritize_my_synapse_2</span>
<span class="sd">        ).serve(</span>
<span class="sd">            netuid = ...</span>
<span class="sd">            subtensor = ...</span>
<span class="sd">        ).start()</span>

<span class="sd">    Args:</span>
<span class="sd">        wallet (Optional[bittensor_wallet.Wallet]): Wallet with hotkey and coldkeypub.</span>
<span class="sd">        config (Optional[bittensor.core.config.Config]): Configuration parameters for the axon.</span>
<span class="sd">        port (Optional[int]): Port for server binding.</span>
<span class="sd">        ip (Optional[str]): Binding IP address.</span>
<span class="sd">        external_ip (Optional[str]): External IP address to broadcast.</span>
<span class="sd">        external_port (Optional[int]): External port to broadcast.</span>
<span class="sd">        max_workers (Optional[int]): Number of active threads for request handling.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bittensor.core.axon.Axon: An instance of the axon class configured as per the provided arguments.</span>

<span class="sd">    Note:</span>
<span class="sd">        This class is a core part of Bittensor&#39;s decentralized network for machine intelligence,</span>
<span class="sd">        allowing neurons to communicate effectively and securely.</span>

<span class="sd">    Importance and Functionality</span>
<span class="sd">        Endpoint Registration</span>
<span class="sd">            This method dynamically registers API endpoints based on the Synapse used, allowing the Axon to respond to specific types of requests and synapses.</span>

<span class="sd">        Customization of Request Handling</span>
<span class="sd">            By attaching different functions, the Axon can customize how it</span>
<span class="sd">            handles, verifies, prioritizes, and potentially blocks incoming requests, making it adaptable to various network scenarios.</span>

<span class="sd">        Security and Efficiency</span>
<span class="sd">            The method contributes to both the security (via verification and blacklisting) and efficiency (via prioritization) of request handling, which are crucial in a decentralized network environment.</span>

<span class="sd">        Flexibility</span>
<span class="sd">            The ability to define custom functions for different aspects of request handling provides great flexibility, allowing the Axon to be tailored to specific needs and use cases within the Bittensor network.</span>

<span class="sd">        Error Handling and Validation</span>
<span class="sd">            The method ensures that the attached functions meet the required</span>
<span class="sd">            signatures, providing error handling to prevent runtime issues.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wallet</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Wallet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">external_ip</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">external_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_workers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new bittensor.Axon object from passed arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (:obj:`Optional[bittensor.core.config.Config]`): bittensor.Axon.config()</span>
<span class="sd">            wallet (:obj:`Optional[bittensor_wallet.Wallet]`): bittensor wallet with hotkey and coldkeypub.</span>
<span class="sd">            port (:type:`Optional[int]`): Binding port.</span>
<span class="sd">            ip (:type:`Optional[str]`): Binding ip.</span>
<span class="sd">            external_ip (:type:`Optional[str]`): The external ip of the server to broadcast to the network.</span>
<span class="sd">            external_port (:type:`Optional[int]`): The external port of the server to broadcast to the network.</span>
<span class="sd">            max_workers (:type:`Optional[int]`): Used to create the threadpool if not passed, specifies the number of active threads servicing requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build and check config.</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Axon</span><span class="o">.</span><span class="n">config</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">ip</span>
        <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">port</span>
        <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_ip</span> <span class="o">=</span> <span class="n">external_ip</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_ip</span>
        <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_port</span> <span class="o">=</span> <span class="n">external_port</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_port</span>
        <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">max_workers</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">max_workers</span>
        <span class="n">Axon</span><span class="o">.</span><span class="n">check_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Get wallet or use default.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="n">wallet</span> <span class="ow">or</span> <span class="n">Wallet</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Build axon objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">ip</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">port</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_ip</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_ip</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_ip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="k">else</span> <span class="n">networking</span><span class="o">.</span><span class="n">get_external_ip</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_port</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_port</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">port</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_address</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Build middleware</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_pool</span> <span class="o">=</span> <span class="n">PriorityThreadPoolExecutor</span><span class="p">(</span>
            <span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">max_workers</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonces</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Request default functions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_class_types</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Signature</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blacklist_fns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_fns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_fns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_fns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Instantiate FastAPI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;trace&quot;</span> <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">__trace_on__</span> <span class="k">else</span> <span class="s2">&quot;critical&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_config</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">log_level</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_server</span> <span class="o">=</span> <span class="n">FastAPIThreadedServer</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fast_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>

        <span class="c1"># Build ourselves as the middleware.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middleware_cls</span> <span class="o">=</span> <span class="n">AxonMiddleware</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middleware_cls</span><span class="p">,</span> <span class="n">axon</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Attach default forward.</span>
        <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="n">r</span><span class="p">:</span> <span class="n">Synapse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Synapse</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span>
            <span class="n">forward_fn</span><span class="o">=</span><span class="n">ping</span><span class="p">,</span> <span class="n">verify_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blacklist_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority_fn</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Axon.info">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.info">[docs]</a>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AxonInfo&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the axon info object associated with this axon.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AxonInfo</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version_as_int</span><span class="p">,</span>
            <span class="n">ip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">external_ip</span><span class="p">,</span>
            <span class="n">ip_type</span><span class="o">=</span><span class="n">networking</span><span class="o">.</span><span class="n">ip_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_ip</span><span class="p">),</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">external_port</span><span class="p">,</span>
            <span class="n">hotkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">hotkey</span><span class="o">.</span><span class="n">ss58_address</span><span class="p">,</span>
            <span class="n">coldkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">coldkeypub</span><span class="o">.</span><span class="n">ss58_address</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">placeholder1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">placeholder2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Axon.attach">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.attach">[docs]</a>
    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">forward_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">blacklist_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">priority_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Axon&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Attaches custom functions to the Axon server for handling incoming requests. This method enables</span>
<span class="sd">        the ``Axon`` to define specific behaviors for request forwarding, verification, blacklisting, and</span>
<span class="sd">        prioritization, thereby customizing its interaction within the Bittensor network.</span>

<span class="sd">        Registers an API endpoint to the FastAPI application router.</span>
<span class="sd">        It uses the name of the first argument of the :func:`forward_fn` function as the endpoint name.</span>

<span class="sd">        The :func:`attach` method in the Bittensor framework&#39;s axon class is a crucial function for registering</span>
<span class="sd">        API endpoints to the Axon&#39;s FastAPI application router. This method allows the Axon server to</span>
<span class="sd">        define how it handles incoming requests by attaching functions for forwarding, verifying,</span>
<span class="sd">        blacklisting, and prioritizing requests. It&#39;s a key part of customizing the server&#39;s behavior</span>
<span class="sd">        and ensuring efficient and secure handling of requests within the Bittensor network.</span>

<span class="sd">        Args:</span>
<span class="sd">            forward_fn (Callable): Function to be called when the API endpoint is accessed. It should have at least one argument.</span>
<span class="sd">            blacklist_fn (Optional[Callable]): Function to filter out undesired requests. It should take the same arguments as :func:`forward_fn` and return a boolean value. Defaults to ``None``, meaning no blacklist filter will be used.</span>
<span class="sd">            priority_fn (Optional[Callable]): Function to rank requests based on their priority. It should take the same arguments as :func:`forward_fn` and return a numerical value representing the request&#39;s priority. Defaults to ``None``, meaning no priority sorting will be applied.</span>
<span class="sd">            verify_fn (Optional[Callable]): Function to verify requests. It should take the same arguments as :func:`forward_fn` and return a boolean value. If ``None``, :func:`self.default_verify` function will be used.</span>

<span class="sd">        Note:</span>
<span class="sd">            The methods :func:`forward_fn`, :func:`blacklist_fn`, :func:`priority_fn`, and :func:`verify_fn` should be designed to receive the same parameters.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If :func:`forward_fn` does not have the signature: ``forward( synapse: YourSynapse ) -&gt; synapse``.</span>
<span class="sd">            AssertionError: If :func:`blacklist_fn` does not have the signature: ``blacklist( synapse: YourSynapse ) -&gt; bool``.</span>
<span class="sd">            AssertionError: If :func:`priority_fn` does not have the signature: ``priority( synapse: YourSynapse ) -&gt; float``.</span>
<span class="sd">            AssertionError: If :func:`verify_fn` does not have the signature: ``verify( synapse: YourSynapse ) -&gt; None``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self: Returns the instance of the AxonServer class for potential method chaining.</span>

<span class="sd">        Example Usage::</span>

<span class="sd">            def forward_custom(synapse: MyCustomSynapse) -&gt; MyCustomSynapse:</span>
<span class="sd">                # Custom logic for processing the request</span>
<span class="sd">                return synapse</span>

<span class="sd">            def blacklist_custom(synapse: MyCustomSynapse) -&gt; tuple[bool, str]:</span>
<span class="sd">                return True, &quot;Allowed!&quot;</span>

<span class="sd">            def priority_custom(synapse: MyCustomSynapse) -&gt; float:</span>
<span class="sd">                return 1.0</span>

<span class="sd">            def verify_custom(synapse: MyCustomSynapse):</span>
<span class="sd">                # Custom logic for verifying the request</span>
<span class="sd">                pass</span>

<span class="sd">            my_axon = bittensor.Axon(...)</span>
<span class="sd">            my_axon.attach(forward_fn=forward_custom, verify_fn=verify_custom)</span>

<span class="sd">        Note:</span>
<span class="sd">            The :func:`attach` method is fundamental in setting up the Axon server&#39;s request handling capabilities,</span>
<span class="sd">            enabling it to participate effectively and securely in the Bittensor network. The flexibility</span>
<span class="sd">            offered by this method allows developers to tailor the Axon&#39;s behavior to specific requirements and</span>
<span class="sd">            use cases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">forward_sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">forward_fn</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_param</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">forward_sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The forward_fn first argument must be a subclass of bittensor.Synapse, but it has no arguments&quot;</span>
            <span class="p">)</span>

        <span class="n">param_class</span> <span class="o">=</span> <span class="n">first_param</span><span class="o">.</span><span class="n">annotation</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span>
            <span class="n">param_class</span><span class="p">,</span> <span class="n">Synapse</span>
        <span class="p">),</span> <span class="s2">&quot;The first argument of forward_fn must inherit from bittensor.Synapse&quot;</span>
        <span class="n">request_name</span> <span class="o">=</span> <span class="n">param_class</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">endpoint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">forward_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Synapse</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware_cls</span><span class="o">.</span><span class="n">synapse_to_response</span><span class="p">(</span>
                    <span class="n">synapse</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response_synapse</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;synapse&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response_synapse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;The response synapse is None. The input synapse will be used as the response synapse. &quot;</span>
                        <span class="s2">&quot;Reliance on forward_fn modifying input synapse as a side-effects is deprecated. &quot;</span>
                        <span class="s2">&quot;Explicitly set `synapse` on response object instead.&quot;</span><span class="p">,</span>
                        <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Replace with `return response` in next major version</span>
                    <span class="n">response_synapse</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware_cls</span><span class="o">.</span><span class="n">synapse_to_response</span><span class="p">(</span>
                    <span class="n">synapse</span><span class="o">=</span><span class="n">response_synapse</span><span class="p">,</span>
                    <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                    <span class="n">response_override</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">forward_sig</span><span class="o">.</span><span class="n">return_annotation</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
            <span class="n">return_annotation</span><span class="p">,</span> <span class="n">Synapse</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span>
                <span class="n">return_annotation</span><span class="p">,</span>
                <span class="n">StreamingSynapse</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The forward_fn return annotation is a subclass of bittensor.StreamingSynapse. &quot;</span>
                    <span class="s2">&quot;Most likely the correct return annotation would be BTStreamingResponse.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">JSONResponse</span>

        <span class="n">endpoint</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">parameters</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">forward_sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">return_annotation</span><span class="o">=</span><span class="n">return_annotation</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add the endpoint to the router, making it available on both GET and POST methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_api_route</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">request_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span>
            <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">],</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_body_integrity</span><span class="p">)],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="p">)</span>

        <span class="c1"># Check the signature of blacklist_fn, priority_fn and verify_fn if they are provided</span>
        <span class="n">expected_params</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Parameter</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;synapse&quot;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">Parameter</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">,</span>
                <span class="n">annotation</span><span class="o">=</span><span class="n">forward_sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">forward_sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">blacklist_fn</span><span class="p">:</span>
            <span class="n">blacklist_sig</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span>
                <span class="n">expected_params</span><span class="p">,</span> <span class="n">return_annotation</span><span class="o">=</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">signature</span><span class="p">(</span><span class="n">blacklist_fn</span><span class="p">)</span> <span class="o">==</span> <span class="n">blacklist_sig</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The blacklist_fn function must have the signature: blacklist( synapse: </span><span class="si">{</span><span class="n">request_name</span><span class="si">}</span><span class="s2"> ) -&gt; tuple[bool, str]&quot;</span>
        <span class="k">if</span> <span class="n">priority_fn</span><span class="p">:</span>
            <span class="n">priority_sig</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span><span class="n">expected_params</span><span class="p">,</span> <span class="n">return_annotation</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">signature</span><span class="p">(</span><span class="n">priority_fn</span><span class="p">)</span> <span class="o">==</span> <span class="n">priority_sig</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The priority_fn function must have the signature: priority( synapse: </span><span class="si">{</span><span class="n">request_name</span><span class="si">}</span><span class="s2"> ) -&gt; float&quot;</span>
        <span class="k">if</span> <span class="n">verify_fn</span><span class="p">:</span>
            <span class="n">verify_sig</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span><span class="n">expected_params</span><span class="p">,</span> <span class="n">return_annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">signature</span><span class="p">(</span><span class="n">verify_fn</span><span class="p">)</span> <span class="o">==</span> <span class="n">verify_sig</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;The verify_fn function must have the signature: verify( synapse: </span><span class="si">{</span><span class="n">request_name</span><span class="si">}</span><span class="s2"> ) -&gt; None&quot;</span>

        <span class="c1"># Store functions in appropriate attribute dictionaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_class_types</span><span class="p">[</span><span class="n">request_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blacklist_fns</span><span class="p">[</span><span class="n">request_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">blacklist_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_fns</span><span class="p">[</span><span class="n">request_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">priority_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_fns</span><span class="p">[</span><span class="n">request_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">verify_fn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_verify</span>
        <span class="p">)</span>  <span class="c1"># Use &#39;default_verify&#39; if &#39;verify_fn&#39; is None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_fns</span><span class="p">[</span><span class="n">request_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">forward_fn</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Axon.config">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.config">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Config&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the command-line arguments to form a Bittensor configuration object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bittensor.core.config.Config: Configuration object with settings from command-line arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">Axon</span><span class="o">.</span><span class="n">add_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>  <span class="c1"># Add specific axon-related arguments</span>
        <span class="k">return</span> <span class="n">Config</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span></div>


<div class="viewcode-block" id="Axon.help">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints the help text (list of command-line arguments and their descriptions) to stdout.&quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">Axon</span><span class="o">.</span><span class="n">add_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>  <span class="c1"># Add specific axon-related arguments</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>  <span class="c1"># Print docstring of the class</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>  <span class="c1"># Print parser&#39;s help text</span></div>


<div class="viewcode-block" id="Axon.add_args">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.add_args">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_args</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds AxonServer-specific command-line arguments to the argument parser.</span>

<span class="sd">        Args:</span>
<span class="sd">            parser (argparse.ArgumentParser): Argument parser to which the arguments will be added.</span>
<span class="sd">            prefix (Optional[str]): Prefix to add to the argument names. Defaults to None.</span>

<span class="sd">        Note:</span>
<span class="sd">            Environment variables are used to define default values for the arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Add command-line arguments to the parser</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">prefix_str</span> <span class="o">+</span> <span class="s2">&quot;axon.port&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The local port this axon endpoint is bound to. i.e. 8091&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">prefix_str</span> <span class="o">+</span> <span class="s2">&quot;axon.ip&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The local ip this axon binds to. ie. [::]&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">prefix_str</span> <span class="o">+</span> <span class="s2">&quot;axon.external_port&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The public port this axon broadcasts to the network. i.e. 8091&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_port</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">prefix_str</span> <span class="o">+</span> <span class="s2">&quot;axon.external_ip&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The external ip this axon broadcasts to the network to. ie. [::]&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_ip</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">prefix_str</span> <span class="o">+</span> <span class="s2">&quot;axon.max_workers&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The maximum number connection handler threads working simultaneously on this endpoint.</span>
<span class="s2">                        The grpc server distributes new worker threads to service requests up to this number.&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">max_workers</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">:</span>
            <span class="c1"># Exception handling for re-parsing arguments</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Axon.verify_body_integrity">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.verify_body_integrity">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">verify_body_integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="s2">&quot;Request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The ``verify_body_integrity`` method in the Bittensor framework is a key security function within the</span>
<span class="sd">        Axon server&#39;s middleware. It is responsible for ensuring the integrity of the body of incoming HTTP</span>
<span class="sd">        requests.</span>

<span class="sd">        It asynchronously verifies the integrity of the body of a request by comparing the hash of required fields</span>
<span class="sd">        with the corresponding hashes provided in the request headers. This method is critical for ensuring</span>
<span class="sd">        that the incoming request payload has not been altered or tampered with during transmission, establishing</span>
<span class="sd">        a level of trust and security between the sender and receiver in the network.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming FastAPI request object containing both headers and the request body.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Returns the parsed body of the request as a dictionary if all the hash comparisons match, indicating that the body is intact and has not been tampered with.</span>

<span class="sd">        Raises:</span>
<span class="sd">            JSONResponse: Raises a JSONResponse with a 400 status code if any of the hash comparisons fail, indicating a potential integrity issue with the incoming request payload. The response includes the detailed error message specifying which field has a hash mismatch.</span>

<span class="sd">        This method performs several key functions:</span>

<span class="sd">        1. Decoding and loading the request body for inspection.</span>
<span class="sd">        2. Gathering required field names for hash comparison from the Axon configuration.</span>
<span class="sd">        3. Loading and parsing the request body into a dictionary.</span>
<span class="sd">        4. Reconstructing the Synapse object and recomputing the hash for verification and logging.</span>
<span class="sd">        5. Comparing the recomputed hash with the hash provided in the request headers for verification.</span>

<span class="sd">        Note:</span>
<span class="sd">            The integrity verification is an essential step in ensuring the security of the data exchange within the Bittensor network. It helps prevent tampering and manipulation of data during transit, thereby maintaining the reliability and trust in the network communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Await and load the request body, so we can inspect it</span>
        <span class="n">body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">()</span>
        <span class="n">request_body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">body</span>

        <span class="n">request_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Load the body dict and check if all required field hashes match</span>
        <span class="n">body_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request_body</span><span class="p">)</span>

        <span class="c1"># Reconstruct the synapse object from the body dict and recompute the hash</span>
        <span class="n">syn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_class_types</span><span class="p">[</span><span class="n">request_name</span><span class="p">](</span><span class="o">**</span><span class="n">body_dict</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="n">parsed_body_hash</span> <span class="o">=</span> <span class="n">syn</span><span class="o">.</span><span class="n">body_hash</span>  <span class="c1"># Rehash the body from request</span>

        <span class="n">body_hash</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;computed_body_hash&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed_body_hash</span> <span class="o">!=</span> <span class="n">body_hash</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Hash mismatch between header body hash </span><span class="si">{</span><span class="n">body_hash</span><span class="si">}</span><span class="s2"> and parsed body hash </span><span class="si">{</span><span class="n">parsed_body_hash</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If body is good, return the parsed body so that it can be passed onto the route function</span>
        <span class="k">return</span> <span class="n">body_dict</span></div>


<div class="viewcode-block" id="Axon.check_config">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.check_config">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">check_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="s2">&quot;Config&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method checks the configuration for the axon&#39;s port and wallet.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (bittensor.core.config.Config): The config object holding axon settings.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If the axon or external ports are not in range [1024, 65535]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="mi">1024</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">port</span> <span class="o">&lt;</span> <span class="mi">65535</span>
        <span class="p">),</span> <span class="s2">&quot;Axon port must be in range [1024, 65535]&quot;</span>

        <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_port</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="mi">1024</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">external_port</span> <span class="o">&lt;</span> <span class="mi">65535</span>
        <span class="p">),</span> <span class="s2">&quot;External port must be in range [1024, 65535]&quot;</span></div>


<div class="viewcode-block" id="Axon.to_string">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.to_string">[docs]</a>
    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides a human-readable representation of the AxonInfo for this Axon.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides a human-readable representation of the Axon instance.&quot;&quot;&quot;</span>
        <span class="n">_started</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="k">else</span> <span class="s2">&quot;stopped&quot;</span>
        <span class="n">_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_fns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Axon(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">hotkey</span><span class="o">.</span><span class="n">ss58_address</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">_started</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">_keys</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides a machine-readable (unambiguous) representation of the Axon instance.</span>
<span class="sd">        It is made identical to __str__ in this case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This magic method is called when the Axon object is about to be destroyed.</span>
<span class="sd">        It ensures that the Axon server shuts down properly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<div class="viewcode-block" id="Axon.start">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.start">[docs]</a>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Axon&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the Axon server and its underlying FastAPI server thread, transitioning the state of the</span>
<span class="sd">        Axon instance to ``started``. This method initiates the server&#39;s ability to accept and process</span>
<span class="sd">        incoming network requests, making it an active participant in the Bittensor network.</span>

<span class="sd">        The start method triggers the FastAPI server associated with the Axon to begin listening for</span>
<span class="sd">        incoming requests. It is a crucial step in making the neuron represented by this Axon operational</span>
<span class="sd">        within the Bittensor network.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bittensor.core.axon.Axon: The Axon instance in the &#39;started&#39; state.</span>

<span class="sd">        Example::</span>

<span class="sd">            my_axon = bittensor.Axon(...)</span>
<span class="sd">            ... # setup axon, attach functions, etc.</span>
<span class="sd">            my_axon.start()  # Starts the axon server</span>

<span class="sd">        Note:</span>
<span class="sd">            After invoking this method, the Axon is ready to handle requests as per its configured endpoints and custom logic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Axon.stop">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.stop">[docs]</a>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Axon&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the Axon server and its underlying GRPC server thread, transitioning the state of the Axon</span>
<span class="sd">        instance to ``stopped``. This method ceases the server&#39;s ability to accept new network requests,</span>
<span class="sd">        effectively removing the neuron&#39;s server-side presence in the Bittensor network.</span>

<span class="sd">        By stopping the FastAPI server, the Axon ceases to listen for incoming requests, and any existing</span>
<span class="sd">        connections are gracefully terminated. This function is typically used when the neuron is being</span>
<span class="sd">        shut down or needs to temporarily go offline.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bittensor.core.axon.Axon: The Axon instance in the &#39;stopped&#39; state.</span>

<span class="sd">        Example::</span>

<span class="sd">            my_axon = bittensor.Axon(...)</span>
<span class="sd">            my_axon.start()</span>
<span class="sd">            ...</span>
<span class="sd">            my_axon.stop()  # Stops the axon server</span>


<span class="sd">        Note:</span>
<span class="sd">            It is advisable to ensure that all ongoing processes or requests are completed or properly handled before invoking this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Axon.serve">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.serve">[docs]</a>
    <span class="k">def</span> <span class="nf">serve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">netuid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">subtensor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Subtensor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">certificate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Certificate</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Axon&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serves the Axon on the specified subtensor connection using the configured wallet. This method</span>
<span class="sd">        registers the Axon with a specific subnet within the Bittensor network, identified by the ``netuid``.</span>
<span class="sd">        It links the Axon to the broader network, allowing it to participate in the decentralized exchange</span>
<span class="sd">        of information.</span>

<span class="sd">        Args:</span>
<span class="sd">            netuid (int): The unique identifier of the subnet to register on. This ID is essential for the Axon to correctly position itself within the Bittensor network topology.</span>
<span class="sd">            subtensor (Optional[bittensor.core.subtensor.Subtensor]): The subtensor connection to use for serving. If not provided, a new connection is established based on default configurations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bittensor.core.axon.Axon: The Axon instance that is now actively serving on the specified subtensor.</span>

<span class="sd">        Example::</span>

<span class="sd">            my_axon = bittensor.Axon(...)</span>
<span class="sd">            subtensor = bt.subtensor(network=&quot;local&quot;) # Local by default</span>
<span class="sd">            my_axon.serve(netuid=1, subtensor=subtensor)  # Serves the axon on subnet with netuid 1</span>

<span class="sd">        Note:</span>
<span class="sd">            The ``serve`` method is crucial for integrating the Axon into the Bittensor network, allowing it</span>
<span class="sd">            to start receiving and processing requests from other neurons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subtensor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subtensor</span><span class="p">,</span> <span class="s2">&quot;serve_axon&quot;</span><span class="p">):</span>
            <span class="n">subtensor</span><span class="o">.</span><span class="n">serve_axon</span><span class="p">(</span><span class="n">netuid</span><span class="o">=</span><span class="n">netuid</span><span class="p">,</span> <span class="n">axon</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate</span><span class="o">=</span><span class="n">certificate</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Axon.default_verify">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.Axon.default_verify">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">default_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to verify the authenticity of a received message using a digital signature.</span>

<span class="sd">        It ensures that the message was not tampered with and was sent by the expected sender.</span>

<span class="sd">        The :func:`default_verify` method in the Bittensor framework is a critical security function within the</span>
<span class="sd">        Axon server. It is designed to authenticate incoming messages by verifying their digital</span>
<span class="sd">        signatures. This verification ensures the integrity of the message and confirms that it was</span>
<span class="sd">        indeed sent by the claimed sender. The method plays a pivotal role in maintaining the trustworthiness</span>
<span class="sd">        and reliability of the communication within the Bittensor network.</span>

<span class="sd">        Key Features</span>
<span class="sd">            Security Assurance</span>
<span class="sd">                The default_verify method is crucial for ensuring the security of the Bittensor network. By verifying digital signatures, it guards against unauthorized access</span>
<span class="sd">                and data manipulation.</span>

<span class="sd">            Preventing Replay Attacks</span>
<span class="sd">                The method checks for increasing nonce values, which is a vital</span>
<span class="sd">                step in preventing replay attacks. A replay attack involves an adversary reusing or</span>
<span class="sd">                delaying the transmission of a valid data transmission to deceive the receiver.</span>
<span class="sd">                The first time a nonce is seen, it is checked for freshness by ensuring it is</span>
<span class="sd">                within an acceptable delta time range.</span>

<span class="sd">            Authenticity and Integrity Checks</span>
<span class="sd">                By verifying that the message&#39;s digital signature matches</span>
<span class="sd">                its content, the method ensures the message&#39;s authenticity (it comes from the claimed</span>
<span class="sd">                sender) and integrity (it hasn&#39;t been altered during transmission).</span>

<span class="sd">            Trust in Communication</span>
<span class="sd">                This method fosters trust in the network communication. Neurons</span>
<span class="sd">                (nodes in the Bittensor network) can confidently interact, knowing that the messages they</span>
<span class="sd">                receive are genuine and have not been tampered with.</span>

<span class="sd">            Cryptographic Techniques</span>
<span class="sd">                The method&#39;s reliance on asymmetric encryption techniques is a</span>
<span class="sd">                cornerstone of modern cryptographic security, ensuring that only entities with the correct</span>
<span class="sd">                cryptographic keys can participate in secure communication.</span>

<span class="sd">        Args:</span>
<span class="sd">            synapse(bittensor.core.synapse.Synapse): bittensor request synapse.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the ``receiver_hotkey`` doesn&#39;t match with ``self.receiver_hotkey``.</span>
<span class="sd">            Exception: If the nonce is not larger than the previous nonce for the same endpoint key.</span>
<span class="sd">            Exception: If the signature verification fails.</span>

<span class="sd">        After successful verification, the nonce for the given endpoint key is updated.</span>

<span class="sd">        Note:</span>
<span class="sd">            The verification process assumes the use of an asymmetric encryption algorithm,</span>
<span class="sd">            where the sender signs the message with their private key and the receiver verifies the</span>
<span class="sd">            signature using the sender&#39;s public key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build the keypair from the dendrite_hotkey</span>
        <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keypair</span> <span class="o">=</span> <span class="n">Keypair</span><span class="p">(</span><span class="n">ss58_address</span><span class="o">=</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">hotkey</span><span class="p">)</span>

            <span class="c1"># Build the signature messages.</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">nonce</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">hotkey</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">hotkey</span><span class="o">.</span><span class="n">ss58_address</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">computed_body_hash</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Build the unique endpoint key.</span>
            <span class="n">endpoint_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">hotkey</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Requests must have nonces to be safe from replays</span>
            <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">nonce</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Missing Nonce&quot;</span><span class="p">)</span>

            <span class="c1"># Newer nonce structure post v7.2</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">V_7_2_0</span>
            <span class="p">):</span>
                <span class="c1"># If we don&#39;t have a nonce stored, ensure that the nonce falls within</span>
                <span class="c1"># a reasonable delta.</span>
                <span class="n">current_time_ns</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">()</span>
                <span class="n">allowed_window_ns</span> <span class="o">=</span> <span class="n">allowed_nonce_window_ns</span><span class="p">(</span>
                    <span class="n">current_time_ns</span><span class="p">,</span> <span class="n">synapse</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nonces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint_key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">nonce</span> <span class="o">&lt;=</span> <span class="n">allowed_window_ns</span>
                <span class="p">):</span>
                    <span class="n">diff_seconds</span><span class="p">,</span> <span class="n">allowed_delta_seconds</span> <span class="o">=</span> <span class="n">calculate_diff_seconds</span><span class="p">(</span>
                        <span class="n">current_time_ns</span><span class="p">,</span> <span class="n">synapse</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">nonce</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Nonce is too old: acceptable delta is </span><span class="si">{</span><span class="n">allowed_delta_seconds</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds but request was </span><span class="si">{</span><span class="n">diff_seconds</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds old&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># If a nonce is stored, ensure the new nonce</span>
                <span class="c1"># is greater than the previous nonce</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nonces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint_key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">nonce</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonces</span><span class="p">[</span><span class="n">endpoint_key</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Nonce is too old, a newer one was last processed&quot;</span><span class="p">)</span>
            <span class="c1"># Older nonce structure pre v7.2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nonces</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint_key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">nonce</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonces</span><span class="p">[</span><span class="n">endpoint_key</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Nonce is too old, a newer one was last processed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">keypair</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">signature</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Signature mismatch with </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">signature</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Success</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nonces</span><span class="p">[</span><span class="n">endpoint_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">nonce</span>  <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SynapseDendriteNoneException</span><span class="p">(</span><span class="n">synapse</span><span class="o">=</span><span class="n">synapse</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="create_error_response">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.create_error_response">[docs]</a>
<span class="k">def</span> <span class="nf">create_error_response</span><span class="p">(</span><span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;JSONResponse&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates an error response based on the provided synapse object.</span>

<span class="sd">    Args:</span>
<span class="sd">        synapse (bittensor.core.synapse.Synapse): The synapse object containing details about the request and the associated axon.</span>

<span class="sd">    Returns:</span>
<span class="sd">        JSONResponse: A JSON response with a status code and content indicating the error message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">synapse</span><span class="o">.</span><span class="n">to_headers</span><span class="p">(),</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid request name&quot;</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">or</span> <span class="mi">400</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">synapse</span><span class="o">.</span><span class="n">to_headers</span><span class="p">(),</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_message</span><span class="p">},</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="log_and_handle_error">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.log_and_handle_error">[docs]</a>
<span class="k">def</span> <span class="nf">log_and_handle_error</span><span class="p">(</span>
    <span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">,</span>
    <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span>
    <span class="n">status_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Logs the error and updates the synapse object with the appropriate error details.</span>

<span class="sd">    Args:</span>
<span class="sd">        synapse (bittensor.core.synapse.Synapse): The synapse object to be updated with error information.</span>
<span class="sd">        exception (Exception): The exception that was raised and needs to be logged and handled.</span>
<span class="sd">        status_code (Optional[int]): The HTTP status code to be set on the synapse object. Defaults to None.</span>
<span class="sd">        start_time (Optional[float]): The timestamp marking the start of the processing, used to calculate process time. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Synapse: The updated synapse object with error details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">SynapseException</span><span class="p">):</span>
        <span class="n">synapse</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">synapse</span> <span class="ow">or</span> <span class="n">synapse</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forward handled exception: </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forward exception: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="o">=</span> <span class="n">TerminalInfo</span><span class="p">()</span>

    <span class="c1"># Set the status code of the synapse to the given status code.</span>
    <span class="n">error_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">error_type</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="c1"># Log the detailed error message for internal use</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">error_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">status_code</span> <span class="ow">and</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span>
    <span class="n">status_message</span> <span class="o">=</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_message</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">SynapseException</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_code</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">PriorityException</span><span class="p">):</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">503</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">UnknownSynapseError</span><span class="p">):</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">BlacklistedException</span><span class="p">):</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">403</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">NotVerifiedException</span><span class="p">):</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">401</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="p">(</span><span class="n">InvalidRequestNameError</span><span class="p">,</span> <span class="n">SynapseParsingError</span><span class="p">)):</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">status_message</span> <span class="o">=</span> <span class="n">status_message</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span> <span class="ow">or</span> <span class="mi">500</span>
        <span class="n">status_message</span> <span class="o">=</span> <span class="n">status_message</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;Internal Server Error #</span><span class="si">{</span><span class="n">error_id</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Set a user-friendly error message</span>
    <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_message</span> <span class="o">=</span> <span class="n">status_message</span>

    <span class="k">if</span> <span class="n">start_time</span><span class="p">:</span>
        <span class="c1"># Calculate the processing time by subtracting the start time from the current time.</span>
        <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">process_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="k">return</span> <span class="n">synapse</span></div>



<div class="viewcode-block" id="AxonMiddleware">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.AxonMiddleware">[docs]</a>
<span class="k">class</span> <span class="nc">AxonMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The `AxonMiddleware` class is a key component in the Axon server, responsible for processing all incoming requests.</span>

<span class="sd">    It handles the essential tasks of verifying requests, executing blacklist checks,</span>
<span class="sd">    running priority functions, and managing the logging of messages and errors. Additionally, the class</span>
<span class="sd">    is responsible for updating the headers of the response and executing the requested functions.</span>

<span class="sd">    This middleware acts as an intermediary layer in request handling, ensuring that each request is</span>
<span class="sd">    processed according to the defined rules and protocols of the Bittensor network. It plays a pivotal</span>
<span class="sd">    role in maintaining the integrity and security of the network communication.</span>

<span class="sd">    Args:</span>
<span class="sd">        app (FastAPI): An instance of the FastAPI application to which this middleware is attached.</span>
<span class="sd">        axon (bittensor.core.axon.Axon): The Axon instance that will process the requests.</span>

<span class="sd">    The middleware operates by intercepting incoming requests, performing necessary preprocessing</span>
<span class="sd">    (like verification and priority assessment), executing the request through the Axon&#39;s endpoints, and</span>
<span class="sd">    then handling any postprocessing steps such as response header updating and logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="s2">&quot;AxonMiddleware&quot;</span><span class="p">,</span> <span class="n">axon</span><span class="p">:</span> <span class="s2">&quot;Axon&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the AxonMiddleware class.</span>

<span class="sd">        Args:</span>
<span class="sd">            app (bittensor.core.axon.AxonMiddleware): An instance of the application where the middleware processor is used.</span>
<span class="sd">            axon (bittensor.core.axon.Axon): The axon instance used to process the requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axon</span> <span class="o">=</span> <span class="n">axon</span>

<div class="viewcode-block" id="AxonMiddleware.dispatch">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.AxonMiddleware.dispatch">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="s2">&quot;Request&quot;</span><span class="p">,</span> <span class="n">call_next</span><span class="p">:</span> <span class="s2">&quot;RequestResponseEndpoint&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously processes incoming HTTP requests and returns the corresponding responses. This</span>
<span class="sd">        method acts as the central processing unit of the AxonMiddleware, handling each step in the</span>
<span class="sd">        request lifecycle.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming HTTP request to be processed.</span>
<span class="sd">            call_next (RequestResponseEndpoint): A callable that processes the request and returns a response.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: The HTTP response generated after processing the request.</span>

<span class="sd">        This method performs several key functions:</span>

<span class="sd">        1. Request Preprocessing: Sets up Synapse object from request headers and fills necessary information.</span>
<span class="sd">        2. Logging: Logs the start of request processing.</span>
<span class="sd">        3. Blacklist Checking: Verifies if the request is blacklisted.</span>
<span class="sd">        4. Request Verification: Ensures the authenticity and integrity of the request.</span>
<span class="sd">        5. Priority Assessment: Evaluates and assigns priority to the request.</span>
<span class="sd">        6. Request Execution: Calls the next function in the middleware chain to process the request.</span>
<span class="sd">        7. Response Postprocessing: Updates response headers and logs the end of the request processing.</span>

<span class="sd">        The method also handles exceptions and errors that might occur during each stage, ensuring that</span>
<span class="sd">        appropriate responses are returned to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Records the start time of the request processing.</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set up the synapse from its headers.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">SynapseException</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exc</span><span class="o">.</span><span class="n">synapse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">synapse</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">synapse</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">synapse</span> <span class="o">=</span> <span class="n">Synapse</span><span class="p">()</span>
                <span class="k">raise</span>

            <span class="c1"># Logs the start of the request processing</span>
            <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;axon     | &lt;-- | </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> B | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">hotkey</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2"> | 200 | Success &quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;axon     | &lt;-- | </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> B | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> | None | None | 200 | Success &quot;</span>
                <span class="p">)</span>

            <span class="c1"># Call the blacklist function</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>

            <span class="c1"># Call verify and return the verified request</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>

            <span class="c1"># Call the priority function</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>

            <span class="c1"># Call the run function</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">synapse</span><span class="p">,</span> <span class="n">call_next</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

        <span class="c1"># Handle errors related to preprocess.</span>
        <span class="k">except</span> <span class="n">InvalidRequestNameError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="o">=</span> <span class="n">TerminalInfo</span><span class="p">()</span>
            <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">synapse</span> <span class="o">=</span> <span class="n">log_and_handle_error</span><span class="p">(</span><span class="n">synapse</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">create_error_response</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">SynapseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">synapse</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">synapse</span> <span class="ow">or</span> <span class="n">synapse</span>
            <span class="n">synapse</span> <span class="o">=</span> <span class="n">log_and_handle_error</span><span class="p">(</span><span class="n">synapse</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">create_error_response</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>

        <span class="c1"># Handle all other errors.</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">synapse</span> <span class="o">=</span> <span class="n">log_and_handle_error</span><span class="p">(</span><span class="n">synapse</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">create_error_response</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>

        <span class="c1"># Logs the end of request processing and returns the response</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Log the details of the processed synapse, including total size, name, hotkey, IP, port,</span>
            <span class="c1"># status code, and status message, using the debug level of the logger.</span>
            <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;axon     | --&gt; | </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> B | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">hotkey</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">  | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_message</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;axon     | --&gt; | </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> B | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> | None | None | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_message</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;axon     | --&gt; | </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> B | </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> | None | None | 200 | Success &quot;</span>
                <span class="p">)</span>

            <span class="c1"># Return the response to the requester.</span>
            <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="AxonMiddleware.preprocess">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.AxonMiddleware.preprocess">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="s2">&quot;Request&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the initial processing of the incoming request. This method is responsible for</span>
<span class="sd">        extracting relevant information from the request and setting up the Synapse object, which</span>
<span class="sd">        represents the state and context of the request within the Axon server.</span>

<span class="sd">        Args:</span>
<span class="sd">            request (Request): The incoming request to be preprocessed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bittensor.core.synapse.Synapse: The Synapse object representing the preprocessed state of the request.</span>

<span class="sd">        The preprocessing involves:</span>

<span class="sd">        1. Extracting the request name from the URL path.</span>
<span class="sd">        2. Creating a Synapse instance from the request headers using the appropriate class type.</span>
<span class="sd">        3. Filling in the Axon and Dendrite information into the Synapse object.</span>
<span class="sd">        4. Signing the Synapse from the Axon side using the wallet hotkey.</span>

<span class="sd">        This method sets the foundation for the subsequent steps in the request handling process,</span>
<span class="sd">        ensuring that all necessary information is encapsulated within the Synapse object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extracts the request name from the URL path.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRequestNameError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Improperly formatted request. Could not parser request </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Creates a synapse instance from the headers using the appropriate forward class type</span>
        <span class="c1"># based on the request name obtained from the URL path.</span>
        <span class="n">request_synapse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">forward_class_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request_synapse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnknownSynapseError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Synapse name &#39;</span><span class="si">{</span><span class="n">request_name</span><span class="si">}</span><span class="s2">&#39; not found. Available synapses </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">forward_class_types</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">synapse</span> <span class="o">=</span> <span class="n">request_synapse</span><span class="o">.</span><span class="n">from_headers</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SynapseParsingError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Improperly formatted request. Could not parse headers </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="si">}</span><span class="s2"> into synapse of type </span><span class="si">{</span><span class="n">request_name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">synapse</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">request_name</span>

        <span class="c1"># Fills the local axon information into the synapse.</span>
        <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">version_as_int</span><span class="p">),</span>
                <span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span>
                <span class="s2">&quot;nonce&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time_ns</span><span class="p">(),</span>
                <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Fills the dendrite information into the synapse.</span>
        <span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span><span class="p">)}</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>

        <span class="c1"># Signs the synapse from the axon side using the wallet hotkey.</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">nonce</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">dendrite</span><span class="o">.</span><span class="n">hotkey</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">hotkey</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">hotkey</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Return the setup synapse.</span>
        <span class="k">return</span> <span class="n">synapse</span></div>


<div class="viewcode-block" id="AxonMiddleware.verify">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.AxonMiddleware.verify">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the authenticity and integrity of the request. This method ensures that the incoming</span>
<span class="sd">        request meets the predefined security and validation criteria.</span>

<span class="sd">        Args:</span>
<span class="sd">            synapse (bittensor.core.synapse.Synapse): The Synapse object representing the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the verification process fails due to unmet criteria or security concerns.</span>

<span class="sd">        The verification process involves:</span>

<span class="sd">        1. Retrieving the specific verification function for the request&#39;s Synapse type.</span>
<span class="sd">        2. Executing the verification function and handling any exceptions that arise.</span>

<span class="sd">        Successful verification allows the request to proceed further in the processing pipeline, while</span>
<span class="sd">        failure results in an appropriate exception being raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start of the verification process. Verification is the process where we ensure that</span>
        <span class="c1"># the incoming request is from a trusted source or fulfills certain requirements.</span>
        <span class="c1"># We get a specific verification function from &#39;verify_fns&#39; dictionary that corresponds</span>
        <span class="c1"># to our request&#39;s name. Each request name (synapse name) has its unique verification function.</span>
        <span class="n">verify_fn</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">verify_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">synapse</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># If a verification function exists for the request&#39;s name</span>
        <span class="k">if</span> <span class="n">verify_fn</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># We attempt to run the verification function using the synapse instance</span>
                <span class="c1"># created from the request. If this function runs without throwing an exception,</span>
                <span class="c1"># it means that the verification was successful.</span>
                <span class="p">(</span>
                    <span class="k">await</span> <span class="n">verify_fn</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">verify_fn</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">verify_fn</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If there was an exception during the verification process, we log that</span>
                <span class="c1"># there was a verification exception.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verify exception </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Check if the synapse.axon object exists</span>
                <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># We set the status code of the synapse to &quot;401&quot; which denotes an unauthorized access.</span>
                    <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">401</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the synapse.axon object doesn&#39;t exist, raise an exception.</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Synapse.axon object is None&quot;</span><span class="p">)</span>

                <span class="c1"># We raise an exception to stop the process and return the error to the requester.</span>
                <span class="c1"># The error message includes the original exception message.</span>
                <span class="k">raise</span> <span class="n">NotVerifiedException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Not Verified with error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">synapse</span><span class="o">=</span><span class="n">synapse</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="AxonMiddleware.blacklist">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.AxonMiddleware.blacklist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">blacklist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the request should be blacklisted. This method ensures that requests from disallowed</span>
<span class="sd">        sources or with malicious intent are blocked from processing. This can be extremely useful for</span>
<span class="sd">        preventing spam or other forms of abuse. The blacklist is a list of keys or identifiers that</span>
<span class="sd">        are prohibited from accessing certain resources.</span>

<span class="sd">        Args:</span>
<span class="sd">            synapse (bittensor.core.synapse.Synapse): The Synapse object representing the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the request is found in the blacklist.</span>

<span class="sd">        The blacklist check involves:</span>

<span class="sd">        1. Retrieving the blacklist checking function for the request&#39;s Synapse type.</span>
<span class="sd">        2. Executing the check and handling the case where the request is blacklisted.</span>

<span class="sd">        If a request is blacklisted, it is blocked, and an exception is raised to halt further processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># A blacklist is a list of keys or identifiers</span>
        <span class="c1"># that are prohibited from accessing certain resources.</span>
        <span class="c1"># We retrieve the blacklist checking function from the &#39;blacklist_fns&#39; dictionary</span>
        <span class="c1"># that corresponds to the request&#39;s name (synapse name).</span>
        <span class="n">blacklist_fn</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">blacklist_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">synapse</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># If a blacklist checking function exists for the request&#39;s name</span>
        <span class="k">if</span> <span class="n">blacklist_fn</span><span class="p">:</span>
            <span class="c1"># We execute the blacklist checking function using the synapse instance as input.</span>
            <span class="c1"># If the function returns True, it means that the key or identifier is blacklisted.</span>
            <span class="n">blacklisted</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">await</span> <span class="n">blacklist_fn</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">blacklist_fn</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">blacklist_fn</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">blacklisted</span><span class="p">:</span>
                <span class="c1"># We log that the key or identifier is blacklisted.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blacklisted: </span><span class="si">{</span><span class="n">blacklisted</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Check if the synapse.axon object exists</span>
                <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># We set the status code of the synapse to &quot;403&quot; which indicates a forbidden access.</span>
                    <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">403</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the synapse.axon object doesn&#39;t exist, raise an exception.</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Synapse.axon object is None&quot;</span><span class="p">)</span>

                <span class="c1"># We raise an exception to halt the process and return the error message to the requester.</span>
                <span class="k">raise</span> <span class="n">BlacklistedException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Forbidden. Key is blacklisted: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">synapse</span><span class="o">=</span><span class="n">synapse</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="AxonMiddleware.priority">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.AxonMiddleware.priority">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the priority function for the request. This method assesses and assigns a priority</span>
<span class="sd">        level to the request, determining its urgency and importance in the processing queue.</span>

<span class="sd">        Args:</span>
<span class="sd">            synapse (bittensor.core.synapse.Synapse): The Synapse object representing the request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If the priority assessment process encounters issues, such as timeouts.</span>

<span class="sd">        The priority function plays a crucial role in managing the processing load and ensuring that</span>
<span class="sd">        critical requests are handled promptly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve the priority function from the &#39;priority_fns&#39; dictionary that corresponds</span>
        <span class="c1"># to the request&#39;s name (synapse name).</span>
        <span class="n">priority_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">priority_fns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">synapse</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_task</span><span class="p">(</span>
            <span class="n">executor</span><span class="p">:</span> <span class="s2">&quot;PriorityThreadPoolExecutor&quot;</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="nb">float</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Submits the given priority function to the specified executor for asynchronous execution.</span>
<span class="sd">            The function will run in the provided executor and return the priority value along with the result.</span>

<span class="sd">            Args:</span>
<span class="sd">                executor (bittensor.core.threadpool.PriorityThreadPoolExecutor): The executor in which the priority function will be run.</span>
<span class="sd">                priority (float): The priority function to be executed.</span>

<span class="sd">            Returns:</span>
<span class="sd">                tuple: A tuple containing the priority value and the result of the priority function execution.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">priority</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
            <span class="k">return</span> <span class="n">priority</span><span class="p">,</span> <span class="n">result</span>

        <span class="c1"># If a priority function exists for the request&#39;s name</span>
        <span class="k">if</span> <span class="n">priority_fn</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Execute the priority function and get the priority value.</span>
                <span class="n">priority</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="k">await</span> <span class="n">priority_fn</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">priority_fn</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">priority_fn</span><span class="p">(</span><span class="n">synapse</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Submit the task to the thread pool for execution with the given priority.</span>
                <span class="c1"># The submit_task function will handle the execution and return the result.</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">submit_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">thread_pool</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If the execution of the priority function exceeds the timeout,</span>
                <span class="c1"># it raises an exception to handle the timeout error.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TimeoutError: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Set the status code of the synapse to 408 which indicates a timeout error.</span>
                <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">408</span>

                <span class="c1"># Raise an exception to stop the process and return an appropriate error message to the requester.</span>
                <span class="k">raise</span> <span class="n">PriorityException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Response timeout after: </span><span class="si">{</span><span class="n">synapse</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">synapse</span><span class="o">=</span><span class="n">synapse</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="AxonMiddleware.run">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.AxonMiddleware.run">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">,</span>
        <span class="n">call_next</span><span class="p">:</span> <span class="s2">&quot;RequestResponseEndpoint&quot;</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="s2">&quot;Request&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Response&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the requested function as part of the request processing pipeline. This method calls</span>
<span class="sd">        the next function in the middleware chain to process the request and generate a response.</span>

<span class="sd">        Args:</span>
<span class="sd">            synapse (bittensor.core.synapse.Synapse): The Synapse object representing the request.</span>
<span class="sd">            call_next (RequestResponseEndpoint): The next function in the middleware chain to process requests.</span>
<span class="sd">            request (Request): The original HTTP request.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: The HTTP response generated by processing the request.</span>

<span class="sd">        This method is a critical part of the request lifecycle, where the actual processing of the</span>
<span class="sd">        request takes place, leading to the generation of a response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">synapse</span><span class="p">,</span> <span class="n">Synapse</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The requested function is executed by calling the &#39;call_next&#39; function,</span>
            <span class="c1"># passing the original request as an argument. This function processes the request</span>
            <span class="c1"># and returns the response.</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log the exception for debugging purposes.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Return the starlet response</span>
        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="AxonMiddleware.synapse_to_response">
<a class="viewcode-back" href="../../../autoapi/bittensor/core/axon/index.html#bittensor.core.axon.AxonMiddleware.synapse_to_response">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">synapse_to_response</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">synapse</span><span class="p">:</span> <span class="s2">&quot;Synapse&quot;</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">response_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Response&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the Synapse object into a JSON response with HTTP headers.</span>

<span class="sd">        Args:</span>
<span class="sd">            synapse (bittensor.core.synapse.Synapse): The Synapse object representing the request.</span>
<span class="sd">            start_time (float): The timestamp when the request processing started.</span>
<span class="sd">            response_override: Instead of serializing the synapse, mutate the provided response object. This is only really useful for StreamingSynapse responses.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response: The final HTTP response, with updated headers, ready to be sent back to the client.</span>

<span class="sd">        Postprocessing is the last step in the request handling process, ensuring that the response is</span>
<span class="sd">        properly formatted and contains all necessary information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span> <span class="o">=</span> <span class="n">TerminalInfo</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>

        <span class="k">if</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_message</span><span class="p">:</span>
            <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_message</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>

        <span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">process_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="k">if</span> <span class="n">response_override</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">response_override</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">serialized_synapse</span> <span class="o">=</span> <span class="k">await</span> <span class="n">serialize_response</span><span class="p">(</span><span class="n">response_content</span><span class="o">=</span><span class="n">synapse</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">JSONResponse</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">synapse</span><span class="o">.</span><span class="n">axon</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">serialized_synapse</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">updated_headers</span> <span class="o">=</span> <span class="n">synapse</span><span class="o">.</span><span class="n">to_headers</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PostProcessException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error while parsing response headers. Postprocess exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">synapse</span><span class="o">=</span><span class="n">synapse</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updated_headers</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PostProcessException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error while updating response headers. Postprocess exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">synapse</span><span class="o">=</span><span class="n">synapse</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">return</span> <span class="n">response</span></div>
</div>

</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Opentensor Foundation
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Opentensor Foundation.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>